---
title: "Docker-in-Docker (DinD) Environment: Because Why Not Run Containers Inside Containers?"
description: "Ever had the urge to get all Inception-y with your containers? Dive into Docker-in-Docker (DinD) and discover the joys of running containers inside other containers. Because why settle for one layer of abstraction when you can have two? Learn about the perks, perfect scenarios, and top tips for making the most of DinD in your dev and test workflows."
date: "2024-07-13"
tags:
  [
    "Docker",
    "DinD",
    "Containers",
    "Kubernetes",
    "CI/CD",
    "Ubuntu",
    "Nvidia",
    "DevOps",
  ]
---

<CustomImage
  src="https://raw.githubusercontent.com/prasad89/blogposts/main/images/dind-meme.jpg"
  alt="DinDMeme"
/>

Ever found yourself needing to nest containers inside other containers? That's where Docker-in-Docker (DinD) swoops in like the Inception of the container world. Picture Docker containers dreaming of Docker containers—it's containers all the way down!

## What is Docker-in-Docker (DinD)?

In a nutshell, DinD lets you pull off container inception. It's like having a Russian doll of Docker: one container holding another, each with its own little world of apps and dependencies. Perfect for when you need to test, build, or even nest your CI/CD pipelines within Docker itself.

## Why Use Docker-in-Docker (DinD)?

So, why would you want to nest containers within containers? Here are some scenarios where DinD shines brighter than a containerized supernova:

1. **Testing Docker Images**: Imagine building Docker images and wanting to test them in a pristine, isolated universe—DinD makes it happen. No more "but it worked on my machine" excuses!
2. **Building Docker Images**: Speed up your image-building process by letting DinD handle the heavy lifting. It's like having a Docker factory inside your Docker factory.
3. **Running CI/CD Pipelines**: Keep your pipelines tidy and snug within Docker. DinD ensures that what works in development also works in production—no surprises, just smooth sailing.
4. **Kubernetes Environments**: Need to run containers inside a Kubernetes pod? DinD's got your back. It's like Kubernetesception, where pods can nest pods—ideal for testing and development.
5. **GPU Workloads**: Got Nvidia GPUs and need to flex their muscles in a container? DinD supports GPU-powered containers, ensuring your GPU-centric apps perform their best.

## How to Set Up Docker-in-Docker (DinD)

Setting up DinD is a breeze, especially if you're using Ubuntu. Here's a quick guide to get you started:

1. **Install Docker**: If you haven't already, install Docker on your host machine. You can use the following command to install Docker on Ubuntu:

```bash
curl -fsSL https://get.docker.com | sh
```

This command fetches Docker like a pro shopper on Black Friday—fast and efficient, without the crowds.

2. **Dockerfile for DinD**: Crafting a Dockerfile for your DinD container is as delightful as assembling a Lego spaceship. Here's a whimsical example to kickstart your Docker-in-Docker adventure:

```dockerfile
# Using Ubuntu 24.04 as the launchpad
FROM ubuntu:24.04

# Installing essential supplies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    gnupg \
    iptables \
    supervisor

# Summoning Docker with the elegance of a magic spell
RUN curl -fsSL https://get.docker.com | sh

# Infusing NVIDIA Container Toolkit for GPU wizardry
RUN curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
    && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    tee /etc/apt/sources.list.d/nvidia-container-toolkit.list \
    && apt-get update \
    && apt-get install -y nvidia-container-toolkit \
    && nvidia-ctk runtime configure --runtime=docker \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Unveiling the entrypoint script and overseeing Supervisor's watchful eye
COPY entrypoint.sh /usr/local/bin/
COPY supervisor/ /etc/supervisor/conf.d/

# Empowering the entrypoint script with executable powers
RUN chmod +x /usr/local/bin/entrypoint.sh

# Creating a sanctuary for Docker's data vault
VOLUME /var/lib/docker

# Guiding the container to its starting point
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# When all else fails, let's have a bash!
CMD ["bash"]
```

This Dockerfile isn't just a recipe; it's a symphony of container orchestration, ensuring your Docker-in-Docker setup is as magical as pulling a rabbit out of a hat. Now, go forth and Dockerize with flair!

3. **Entrypoint Script**: Every container needs a guiding light, and your DinD container is no exception. Behold, a snippet of an entrypoint script that shepherds your DinD container to greatness:

```bash
#!/bin/bash

# Function to patiently wait for a process to awaken
function wait_for_process() {
    local max_time_wait=30
    local process_name="$1"
    local waited_sec=0
    while ! pgrep "$process_name" >/dev/null && ((waited_sec < max_time_wait)); do
        echo "Waiting for $process_name to stir from its slumber..."
        echo "Time elapsed: $waited_sec seconds of $max_time_wait seconds"
        sleep 1
        ((waited_sec++))
        if ((waited_sec >= max_time_wait)); then
            return 1
        fi
    done
    return 0
}

echo "Initiating Supervisor mode..."
supervisord -n >> /dev/null 2>&1 &

echo "Awaiting the majestic awakening of dockerd..."
wait_for_process dockerd
if [ $? -ne 0 ]; then
    echo "Error: dockerd failed to rouse after maximum waiting time"
    exit 1
else
    echo "dockerd is now gracefully awake"
fi

# It's showtime! Execute the command that awaits
exec "$@"
```

This script is not just a guide; it's a seasoned sherpa ensuring your DinD container wakes up calmly and confidently, ready to conquer the containerized world.

4. **Supervisor Configuration**: To keep your DinD container in check, you'll want a Supervisor configuration file that supervises like a pro:

```ini
[program:dockerd]
command=/usr/bin/dockerd
autostart=true
autorestart=true
stderr_logfile=/var/log/dockerd.err.log
stdout_logfile=/var/log/dockerd.out.log
```

This Supervisor configuration file is your vigilant overseer, ensuring that dockerd operates with the finesse of a well-trained acrobat, gracefully managing your Docker-in-Docker spectacle.

With these components in place, your DinD environment is not just a container inception; it's a symphony of container orchestration, orchestrated with wit and wisdom.